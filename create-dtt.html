<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Trip Ticket - DPWH</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

  <!-- Gmail-Style Modal System -->
  <link rel="stylesheet" href="modal-styles.css">

  <!-- Fix for getComputedStyle errors -->
  <script src="fix-getcomputedstyle.js"></script>

  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- DTT PDF Generator -->
  <script src="dtt-pdf-generator.js"></script>
  
  <style>
    :root {
      --dpwh-blue: #003f87;
      --dpwh-light-blue: #0056b3;
    }
    
    body {
      background: linear-gradient(135deg, #e3f2fd 0%, #fff9c4 100%);
      min-height: 100vh;
    }
    
    .header-dpwh {
      background: linear-gradient(135deg, var(--dpwh-blue) 0%, var(--dpwh-light-blue) 100%);
      color: white;
      padding: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .form-section {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    
    .section-title {
      color: var(--dpwh-blue);
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--dpwh-blue);
    }
    
    .auto-caps {
      text-transform: uppercase;
    }
    
    .passenger-item {
      background: #f8f9fa;
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: between;
      align-items: center;
    }
    
    .btn-submit {
      background: linear-gradient(135deg, var(--dpwh-blue) 0%, var(--dpwh-light-blue) 100%);
      border: none;
      padding: 1rem;
      font-weight: 600;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>

  <!-- Loading Splash -->
  <div id="auth-loading" class="container d-flex align-items-center justify-content-center min-vh-100">
    <div class="text-center">
      <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-muted">Loading...</p>
    </div>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="d-none">

  <!-- Header -->
  <div class="header-dpwh">
    <div class="container">
      <div class="d-flex align-items-center">
        <button onclick="goBack()" class="btn btn-outline-light btn-sm me-3">
          <i class="bi bi-arrow-left"></i>
        </button>
        <div>
          <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>New Trip Ticket</h5>
          <small>DPWH Regional Office II</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Form -->
  <!-- [FIX] Changed mb-5 to inline style with 7rem bottom margin to prevent overlap with bottom navigation -->
  <div class="container py-4" style="margin-bottom: 7rem;">
    
    <!-- PART 1: Basic Information -->
    <div class="form-section">
      <h6 class="section-title">
        <i class="bi bi-1-circle me-2"></i>TRIP INFORMATION
      </h6>
      
      <!-- Vehicle & Plate No. -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Vehicle <span class="text-danger">*</span></label>
          <div class="input-group">
            <input type="text" id="vehicle-search" class="form-control" placeholder="Search vehicle...">
            <button type="button" class="btn btn-primary" onclick="showVehicleSearchModal()">
              <i class="bi bi-search"></i> Search
            </button>
          </div>
          <input type="hidden" id="vehicle" value="">
          <div id="selected-vehicle" class="mt-2 text-muted"></div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Plate No. <span class="text-danger">*</span></label>
          <input type="text" id="plateNo" class="form-control auto-caps" readonly>
        </div>
      </div>

      <!-- Fuel Balance Info -->
      <div id="fuel-info" class="alert alert-info d-none mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <span><i class="bi bi-fuel-pump me-2"></i>Current Fuel Balance:</span>
          <strong id="current-fuel" class="fs-5">0 L</strong>
        </div>
      </div>

      <!-- Authorized Passengers -->
      <div class="mb-3">
        <label class="form-label">
          Name of Authorized Passenger/s
        </label>
        
        <div class="input-group mb-2">
          <input type="text" id="passenger-input" class="form-control auto-caps" 
                 placeholder="ENTER PASSENGER NAME">
          <button onclick="addPassenger()" class="btn btn-primary" type="button">
            <i class="bi bi-plus-lg"></i> Add
          </button>
        </div>
        
        <div id="passengers-list"></div>
      </div>

      <!-- Destination -->
      <div class="mb-3">
        <label class="form-label">Destination <span class="text-danger">*</span></label>
        <input type="text" id="destination" class="form-control auto-caps" 
               placeholder="E.G., TUGUEGARAO CITY">
      </div>

      <!-- Period Covered -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Period Covered - From <span class="text-danger">*</span></label>
          <input type="date" id="periodFrom" class="form-control" onchange="validatePeriodDates()">
        </div>
        <div class="col-md-6">
          <label class="form-label">Period Covered - To <span class="text-danger">*</span></label>
          <input type="date" id="periodTo" class="form-control" onchange="validatePeriodDates()">
        </div>
      </div>
      <div id="date-error" class="alert alert-danger d-none mb-3"></div>

      <!-- Purpose -->
      <div class="mb-3">
        <label class="form-label">Purpose <span class="text-danger">*</span></label>
        <textarea id="purpose" rows="3" class="form-control auto-caps" 
                  placeholder="E.G., OFFICIAL TRAVEL TO CONDUCT INSPECTION"></textarea>
      </div>
    </div>

    <!-- Request Fuel Section -->
    <div class="form-section">
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="requestFuel" onchange="toggleFuelRequest()">
        <label class="form-check-label fw-bold" for="requestFuel">
          <i class="bi bi-fuel-pump-fill text-warning me-2"></i>
          Request fuel for this trip
        </label>
      </div>

      <div id="fuel-section" class="d-none">
        <div class="alert alert-warning">
          <label class="form-label">Liters Needed <span class="text-danger">*</span></label>
          <div class="input-group">
            <input type="number" id="fuel-qty" class="form-control" 
                   placeholder="50" step="0.1" min="0">
            <span class="input-group-text">liters</span>
          </div>
          <small class="text-muted">
            Balance after refuel: <strong id="balance-after">0 L</strong>
          </small>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="d-grid gap-3">
      <button onclick="submitDtt()" class="btn btn-primary btn-submit">
        <i class="bi bi-check-circle me-2"></i>Submit Trip Ticket
      </button>

      <button onclick="goBack()" class="btn btn-outline-secondary">
        <i class="bi bi-x-circle me-2"></i>Cancel
      </button>
    </div>

  </div>

  </div> <!-- End main-content -->

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Gmail-Style Modal System -->
  <script src="modal-system.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDTPngeGZviiOjv3N1V_wPTGvRUVFOPa14",
      authDomain: "fuel-vehicle-management.firebaseapp.com",
      projectId: "fuel-vehicle-management",
      storageBucket: "fuel-vehicle-management.firebasestorage.app",
      messagingSenderId: "821758027736",
      appId: "1:821758027736:web:3b1924046e73cb0c9434ad"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentFuelBalance = 0;
    let passengers = [];

    // Check auth
    auth.onAuthStateChanged(user => {
      if (!user) {
        // Not logged in - redirect to login
        window.location.href = 'index.html';
      } else {
        // Logged in - show content and load vehicles
        document.getElementById('auth-loading').classList.add('d-none');
        document.getElementById('main-content').classList.remove('d-none');
        loadVehicles();
      }
    });

    // Auto-capitalize all inputs with auto-caps class
    document.addEventListener('DOMContentLoaded', function() {
      const autoCapsInputs = document.querySelectorAll('.auto-caps');
      autoCapsInputs.forEach(input => {
        input.addEventListener('input', function() {
          this.value = this.value.toUpperCase();
        });
      });
    });

    // Vehicle cache
    let vehiclesCache = null;
    let vehiclesCacheTime = null;
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

    // Load vehicles into cache
    async function loadVehicles() {
      try {
        // Check cache first
        const now = Date.now();
        if (vehiclesCache && vehiclesCacheTime && (now - vehiclesCacheTime < CACHE_DURATION)) {
          console.log('Using cached vehicles');
          return;
        }

        // Load all vehicles for search
        const vehiclesSnapshot = await db.collection('vehicles').get();

        // Cache the results
        vehiclesCache = [];
        vehiclesSnapshot.forEach(doc => {
          vehiclesCache.push(doc.data());
        });
        vehiclesCacheTime = Date.now();
        console.log('Loaded', vehiclesCache.length, 'vehicles');
      } catch (error) {
        console.error('Error loading vehicles:', error);
      }
    }

    // Show vehicle search modal
    async function showVehicleSearchModal() {
      // Ensure vehicles are loaded
      await loadVehicles();

      const searchInput = document.getElementById('vehicle-search').value.trim().toUpperCase();

      // Filter vehicles based on search
      let filteredVehicles = vehiclesCache;
      if (searchInput) {
        filteredVehicles = vehiclesCache.filter(v =>
          v.brand.includes(searchInput) ||
          v.model.includes(searchInput) ||
          v.plateNo.includes(searchInput) ||
          (v.dpwhNo && v.dpwhNo.includes(searchInput))
        );
      }

      if (filteredVehicles.length === 0) {
        modalManager.alert({
          title: 'No Vehicles Found',
          message: `No vehicles match "${searchInput}". Try a different search.`,
          type: 'warning'
        });
        return;
      }

      // Build vehicle list HTML
      let vehicleListHtml = '<div class="list-group" style="max-height: 400px; overflow-y: auto;">';
      filteredVehicles.forEach(vehicle => {
        vehicleListHtml += `
          <a href="#" class="list-group-item list-group-item-action" onclick="selectVehicle('${vehicle.plateNo}', '${vehicle.brand}', '${vehicle.model}', ${vehicle.currentFuelBalance || 0}, '${vehicle.dpwhNo || 'N/A'}'); return false;">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">${vehicle.brand} ${vehicle.model}</h6>
              <small>${vehicle.plateNo}</small>
            </div>
            <small class="text-muted">DPWH No: ${vehicle.dpwhNo || 'N/A'} | Fuel: ${(vehicle.currentFuelBalance || 0).toFixed(1)}L</small>
          </a>
        `;
      });
      vehicleListHtml += '</div>';

      modalManager.show({
        title: `Select Vehicle (${filteredVehicles.length} found)`,
        content: vehicleListHtml,
        size: 'medium',
        buttons: [
          { label: 'Cancel', type: 'secondary' }
        ]
      });
    }

    // Select vehicle from modal
    function selectVehicle(plateNo, brand, model, fuelBalance, dpwhNo) {
      document.getElementById('vehicle').value = plateNo;
      document.getElementById('plateNo').value = plateNo;
      document.getElementById('vehicle-search').value = `${brand} ${model} (${plateNo})`;
      document.getElementById('selected-vehicle').innerHTML = `<small><i class="bi bi-check-circle-fill text-success"></i> ${brand} ${model} - ${plateNo} (DPWH: ${dpwhNo})</small>`;

      currentFuelBalance = fuelBalance;
      document.getElementById('current-fuel').textContent = fuelBalance.toFixed(1) + ' L';
      document.getElementById('fuel-info').classList.remove('d-none');

      // Close modal
      modalManager.closeAll();
    }

    // Date validation
    function validatePeriodDates() {
      const periodFrom = document.getElementById('periodFrom').value;
      const periodTo = document.getElementById('periodTo').value;
      const errorDiv = document.getElementById('date-error');

      if (!periodFrom || !periodTo) {
        errorDiv.classList.add('d-none');
        return true;
      }

      const fromDate = new Date(periodFrom);
      const toDate = new Date(periodTo);

      if (fromDate > toDate) {
        errorDiv.textContent = 'Period Covered - From cannot be later than Period Covered - To';
        errorDiv.classList.remove('d-none');
        return false;
      }

      errorDiv.classList.add('d-none');
      return true;
    }

    // Add passenger
    function addPassenger() {
      const input = document.getElementById('passenger-input');
      const name = input.value.trim().toUpperCase();

      if (!name) {
        modalManager.alert({
          title: 'Missing Information',
          message: 'Please enter passenger name.',
          type: 'warning'
        });
        return;
      }

      passengers.push(name);
      input.value = '';
      renderPassengers();
    }

    // Remove passenger
    function removePassenger(index) {
      passengers.splice(index, 1);
      renderPassengers();
    }

    // Render passengers list
    function renderPassengers() {
      const list = document.getElementById('passengers-list');
      if (passengers.length === 0) {
        list.innerHTML = '<small class="text-muted">No passengers added yet</small>';
        return;
      }
      
      list.innerHTML = passengers.map((name, index) => `
        <div class="passenger-item">
          <span>${index + 1}. ${name}</span>
          <button onclick="removePassenger(${index})" class="btn btn-sm btn-outline-danger ms-auto">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      `).join('');
    }

    // Toggle fuel request
    function toggleFuelRequest() {
      const checked = document.getElementById('requestFuel').checked;
      const section = document.getElementById('fuel-section');
      
      if (checked) {
        section.classList.remove('d-none');
      } else {
        section.classList.add('d-none');
      }
    }

    // Calculate fuel balance after refuel
    document.getElementById('fuel-qty').addEventListener('input', function() {
      const fuelNeeded = parseFloat(this.value) || 0;
      const balanceAfter = currentFuelBalance + fuelNeeded;
      document.getElementById('balance-after').textContent = balanceAfter.toFixed(1) + ' L';
    });

    // Generate DTT PDF
    function generateDttPdf(dttData) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // DPWH Header
      doc.setFillColor(0, 63, 135); // DPWH Blue
      doc.rect(0, 0, 210, 25, 'F');

      doc.setTextColor(255, 255, 255);
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text('DPWH REGIONAL OFFICE II', 105, 10, { align: 'center' });
      doc.setFontSize(12);
      doc.text('DRIVER\'S TRIP TICKET', 105, 17, { align: 'center' });

      // Reset text color
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(10);

      let y = 35;

      // DTT ID and Date
      doc.setFont(undefined, 'bold');
      doc.text(`DTT ID: ${dttData.dttId}`, 20, y);
      doc.setFont(undefined, 'normal');
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 150, y);

      y += 10;

      // Trip Information Section
      doc.setFont(undefined, 'bold');
      doc.setFontSize(12);
      doc.text('TRIP INFORMATION', 20, y);
      doc.line(20, y + 2, 190, y + 2);

      y += 10;
      doc.setFontSize(10);

      doc.text('Destination:', 20, y);
      doc.setFont(undefined, 'normal');
      doc.text(dttData.destination, 60, y);
      y += 7;

      doc.setFont(undefined, 'bold');
      doc.text('Purpose:', 20, y);
      doc.setFont(undefined, 'normal');
      const purposeLines = doc.splitTextToSize(dttData.purpose, 130);
      doc.text(purposeLines, 60, y);
      y += (purposeLines.length * 7);

      doc.setFont(undefined, 'bold');
      doc.text('Period Covered:', 20, y);
      doc.setFont(undefined, 'normal');
      doc.text(`${dttData.periodFrom} to ${dttData.periodTo}`, 60, y);
      y += 10;

      // Vehicle Information Section
      doc.setFont(undefined, 'bold');
      doc.setFontSize(12);
      doc.text('VEHICLE INFORMATION', 20, y);
      doc.line(20, y + 2, 190, y + 2);

      y += 10;
      doc.setFontSize(10);

      doc.text('Plate Number:', 20, y);
      doc.setFont(undefined, 'normal');
      doc.text(dttData.plateNo, 60, y);
      y += 7;

      doc.setFont(undefined, 'bold');
      doc.text('Driver:', 20, y);
      doc.setFont(undefined, 'normal');
      doc.text(dttData.driverName, 60, y);
      y += 7;

      if (dttData.passengers && dttData.passengers.length > 0) {
        doc.setFont(undefined, 'bold');
        doc.text('Passengers:', 20, y);
        doc.setFont(undefined, 'normal');
        const passengerText = dttData.passengers.join(', ');
        const passengerLines = doc.splitTextToSize(passengerText, 130);
        doc.text(passengerLines, 60, y);
        y += (passengerLines.length * 7);
      }

      y += 3;

      // Odometer Reading Section
      doc.setFont(undefined, 'bold');
      doc.setFontSize(12);
      doc.text('ODOMETER READING', 20, y);
      doc.line(20, y + 2, 190, y + 2);

      y += 10;
      doc.setFontSize(10);

      doc.text('Start:', 20, y);
      doc.setFont(undefined, 'normal');
      doc.text(`${dttData.speedometerStart || 0} km`, 60, y);
      y += 10;

      // Fuel Information Section
      doc.setFont(undefined, 'bold');
      doc.setFontSize(12);
      doc.text('FUEL INFORMATION', 20, y);
      doc.line(20, y + 2, 190, y + 2);

      y += 10;
      doc.setFontSize(10);

      doc.text('Fuel Balance Start:', 20, y);
      doc.setFont(undefined, 'normal');
      doc.text(`${dttData.fuelBalanceStart || 0} L`, 60, y);
      y += 7;

      if (dttData.requestFuel) {
        doc.setFont(undefined, 'bold');
        doc.setTextColor(234, 134, 0); // Orange
        doc.text('FUEL REQUESTED', 20, y);
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'normal');
        doc.text(`${dttData.requisitionQty} Liters`, 60, y);
        y += 10;
      } else {
        y += 3;
      }

      // Gasoline Details (if provided)
      if (dttData.totalGasoline && dttData.totalGasoline > 0) {
        doc.setFont(undefined, 'bold');
        doc.text('Gasoline Issued:', 20, y);
        y += 7;
        doc.setFont(undefined, 'normal');
        doc.text(`Balance in Tank: ${dttData.balanceInTank || 0} L`, 30, y);
        y += 7;
        doc.text(`Issued by Office: ${dttData.issuedByOffice || 0} L`, 30, y);
        y += 7;
        doc.text(`Purchased During Trip: ${dttData.purchasedDuringTrip || 0} L`, 30, y);
        y += 7;
        doc.setFont(undefined, 'bold');
        doc.text(`Total: ${dttData.totalGasoline} L`, 30, y);
        y += 10;
      }

      // Remarks
      if (dttData.remarks) {
        doc.setFont(undefined, 'bold');
        doc.setFontSize(12);
        doc.text('REMARKS', 20, y);
        doc.line(20, y + 2, 190, y + 2);
        y += 10;
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        const remarkLines = doc.splitTextToSize(dttData.remarks, 170);
        doc.text(remarkLines, 20, y);
        y += (remarkLines.length * 7) + 10;
      } else {
        y += 10;
      }

      // Signature Section
      if (y > 250) {
        doc.addPage();
        y = 20;
      }

      doc.setFontSize(10);
      doc.text('_________________________', 20, y + 20);
      doc.text('Driver\'s Signature', 20, y + 27);
      doc.text('Date: ______________', 20, y + 34);

      doc.text('_________________________', 110, y + 20);
      doc.text('Approved by (Division Chief)', 110, y + 27);
      doc.text('Date: ______________', 110, y + 34);

      // Footer
      doc.setFontSize(8);
      doc.setTextColor(128, 128, 128);
      doc.text('Generated by DPWH Vehicle Management System', 105, 285, { align: 'center' });

      return doc;
    }

    // Submit DTT
    async function submitDtt() {
      // Get form values
      const vehicle = document.getElementById('vehicle').value;
      const plateNo = document.getElementById('plateNo').value;
      const destination = document.getElementById('destination').value.trim();
      const periodFrom = document.getElementById('periodFrom').value;
      const periodTo = document.getElementById('periodTo').value;
      const purpose = document.getElementById('purpose').value.trim();
      const requestFuel = document.getElementById('requestFuel').checked;
      const fuelQty = requestFuel ? parseFloat(document.getElementById('fuel-qty').value) : 0;

      // Validation
      if (!vehicle) {
        modalManager.alert({
          title: 'Missing Information',
          message: 'Please select a vehicle.',
          type: 'warning'
        });
        return;
      }
      if (!destination) {
        modalManager.alert({
          title: 'Missing Information',
          message: 'Please enter destination.',
          type: 'warning'
        });
        return;
      }
      if (!periodFrom || !periodTo) {
        modalManager.alert({
          title: 'Missing Information',
          message: 'Please select period covered.',
          type: 'warning'
        });
        return;
      }
      // Validate date range
      if (!validatePeriodDates()) {
        return;
      }
      if (!purpose || purpose.length < 10) {
        modalManager.alert({
          title: 'Invalid Input',
          message: 'Please enter purpose (at least 10 characters).',
          type: 'warning'
        });
        return;
      }
      if (requestFuel && (!fuelQty || fuelQty <= 0)) {
        modalManager.alert({
          title: 'Missing Information',
          message: 'Please enter fuel quantity needed.',
          type: 'warning'
        });
        return;
      }

      // Show loading
      const loadingId = modalManager.loading({
        title: 'Submitting Trip Ticket',
        message: 'Please wait...'
      });

      try {
        const user = auth.currentUser;
        const dttId = 'DTT_' + Date.now();

        // Prepare DTT data
        const dttData = {
          dttId: dttId,
          driverUid: user.uid,
          driverEmail: user.email,
          driverName: user.displayName || user.email,
          plateNo: plateNo,

          // Trip Info
          destination: destination,
          periodFrom: periodFrom,
          periodTo: periodTo,
          purpose: purpose,
          passengers: passengers,

          // Trip Details - will be filled when closing trip
          timeDepartOffice: null,
          timeArrivalDest: null,
          timeDepartDest: null,
          timeArrivalOffice: null,
          approximateDistance: 0,
          balanceInTank: 0,
          issuedByOffice: 0,
          purchasedDuringTrip: 0,
          totalGasoline: 0,
          gearOil: 0,
          lubOil: 0,
          grease: 0,
          speedometerStart: 0,
          speedometerEnd: 0,
          distanceTravelled: 0,
          remarks: '',

          // Fuel Request
          fuelBalanceStart: currentFuelBalance,
          requestFuel: requestFuel,
          requisitionQty: fuelQty,

          status: 'Draft',
          pdfGenerated: true,
          // TODO Phase 2: Add pdfDriveUrl when Cloud Function uploads to Drive
          // Google Drive Folder ID: 1sQbu0kRzgnSqG7areh5WQnVlo_C2YTBM
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Create DTT document
        await db.collection('dtts').doc(dttId).set(dttData);

        // Update loading message
        modalManager.close(loadingId);

        // Generate PDF for download/view
        const pdf = generateDttPdf(dttData);

        // Show success with PDF options
        const successModal = modalManager.show({
          title: 'Trip Ticket Created Successfully!',
          content: `
            <div class="text-center mb-3">
              <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
            </div>

            <div class="modal-info-row">
              <div class="modal-info-label">DTT ID</div>
              <div class="modal-important-info">${dttId}</div>
            </div>

            <div class="modal-info-row">
              <div class="modal-info-label">Destination</div>
              <div class="modal-important-info">${destination}</div>
            </div>

            <div class="alert alert-info mt-3">
              <i class="bi bi-info-circle me-2"></i>
              Download and print this DTT for signatures before your trip.
            </div>
          `,
          size: 'medium',
          closable: false,
          buttons: [
            {
              label: 'Download PDF',
              type: 'primary',
              icon: 'download',
              onClick: () => {
                pdf.save(`DTT_${dttId}.pdf`);
              },
              closeOnClick: false
            },
            {
              label: 'View PDF',
              type: 'secondary',
              icon: 'eye',
              onClick: () => {
                window.open(pdf.output('bloburl'), '_blank');
              },
              closeOnClick: false
            },
            {
              label: 'Done',
              type: 'success',
              onClick: () => {
                window.location.href = 'index.html';
              }
            }
          ]
        });

      } catch (error) {
        console.error('Error creating DTT:', error);
        modalManager.close(loadingId);
        modalManager.alert({
          title: 'Error',
          message: 'Failed to create trip ticket: ' + error.message,
          type: 'error'
        });
      }
    }

    // Go back
    async function goBack() {
      const confirmed = await modalManager.confirm({
        title: 'Confirm Cancel',
        message: 'Are you sure you want to cancel? All data will be lost.',
        confirmText: 'Yes, Cancel',
        cancelText: 'No, Stay',
        confirmType: 'danger'
      });

      if (confirmed) {
        window.location.href = 'index.html';
      }
    }

    // Initialize passengers list
    renderPassengers();
  </script>

</body>
</html>