<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#003f87">
  <title>DPWH Vehicle Management</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

  <!-- Gmail-Style Modal System -->
  <link rel="stylesheet" href="modal-styles.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <style>
    :root {
      --dpwh-blue: #003f87;
      --dpwh-gold: #ffc107;
      --dpwh-light-blue: #0056b3;
    }
    
    body {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .login-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .login-header {
      background: linear-gradient(135deg, var(--dpwh-blue) 0%, var(--dpwh-light-blue) 100%);
      padding: 2rem;
      text-align: center;
      color: white;
    }
    
    .dpwh-logo {
      width: 80px;
      height: 80px;
      background: white;
      border-radius: 50%;
      margin: 0 auto 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      color: var(--dpwh-blue);
    }
    
    .home-header {
      background: linear-gradient(135deg, var(--dpwh-blue) 0%, var(--dpwh-light-blue) 100%);
      color: white;
      padding: 1.5rem 0;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .stat-card {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      border-left: 4px solid var(--dpwh-blue);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .stat-icon {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--dpwh-blue) 0%, var(--dpwh-light-blue) 100%);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      color: white;
      margin-bottom: 1rem;
    }
    
    .action-btn {
      border-radius: 15px;
      padding: 1rem;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.3s;
      border: none;
    }
    
    .action-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .btn-primary-dpwh {
      background: linear-gradient(135deg, var(--dpwh-blue) 0%, var(--dpwh-light-blue) 100%);
      color: white;
    }
    
    .bottom-nav {
      background: white;
      box-shadow: 0 -4px 6px rgba(0,0,0,0.1);
      padding: 0.75rem 0;
    }
    
    .bottom-nav-item {
      text-align: center;
      color: #6c757d;
      text-decoration: none;
      transition: all 0.3s;
    }
    
    .bottom-nav-item:hover,
    .bottom-nav-item.active {
      color: var(--dpwh-blue);
    }
    
    .bottom-nav-icon {
      font-size: 1.5rem;
      display: block;
      margin-bottom: 0.25rem;
    }
  </style>
</head>
<body>

  <!-- Loading Splash -->
  <div id="auth-loading" class="container d-flex align-items-center justify-content-center min-vh-100">
    <div class="text-center">
      <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-muted">Loading...</p>
    </div>
  </div>

  <!-- Login Screen -->
  <div id="login-screen" class="container d-flex align-items-center justify-content-center min-vh-100 d-none">
    <div class="col-12 col-md-6 col-lg-4">
      <div class="login-card">
        <div class="login-header">
          <div class="dpwh-logo">
            <i class="bi bi-truck"></i>
          </div>
          <h4 class="mb-1">DPWH Regional Office II</h4>
          <p class="mb-0 small">Vehicle Management System</p>
        </div>
        
        <div class="p-4">
          <div class="mb-3">
            <label class="form-label">Email Address</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-envelope"></i></span>
              <input type="email" id="email" class="form-control" placeholder="driver@dpwh.gov.ph" autocomplete="email">
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Password</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-lock"></i></span>
              <input type="password" id="password" class="form-control" placeholder="••••••••" autocomplete="current-password" onkeypress="if(event.key==='Enter') login()">
              <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()">
                <i class="bi bi-eye" id="password-toggle-icon"></i>
              </button>
            </div>
          </div>

          <button onclick="login()" class="btn btn-primary-dpwh w-100 action-btn">
            <i class="bi bi-box-arrow-in-right me-2"></i>Sign In
          </button>
          
          <p class="text-center text-muted mt-4 mb-0 small">
            Department of Public Works and Highways<br>
            Regional Office II
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Home Screen -->
  <div id="home-screen" class="d-none">
    
    <!-- Header -->
    <div class="home-header">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-1"><i class="bi bi-truck me-2"></i>DPWH Vehicle System</h5>
            <p class="mb-0 small" id="user-name">Loading...</p>
          </div>
          <button onclick="logout()" class="btn btn-outline-light btn-sm">
            <i class="bi bi-box-arrow-right me-1"></i>Logout
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="container py-4 mb-5">
      
      <!-- Stats Cards -->
      <div class="row g-3 mb-4">
        <div class="col-6">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="bi bi-clipboard-check"></i>
            </div>
            <h3 class="mb-0" id="trips-count">0</h3>
            <p class="text-muted mb-0 small">My Trips</p>
          </div>
        </div>
        
        <div class="col-6">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="bi bi-fuel-pump"></i>
            </div>
            <h3 class="mb-0" id="fuel-count">0</h3>
            <p class="text-muted mb-0 small">Fuel Requests</p>
          </div>
        </div>
      </div>

      <!-- Vehicle Info -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <h6 class="card-title text-primary mb-3">
            <i class="bi bi-car-front me-2"></i>My Vehicle
          </h6>
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-1">H1 5750</h5>
              <p class="text-muted mb-0 small">Toyota Vios</p>
            </div>
            <div class="text-end">
              <h4 class="mb-0 text-success">43.5L</h4>
              <p class="text-muted mb-0 small">Fuel Balance</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="d-grid gap-3">
        <button onclick="showCreateDtt()" class="btn btn-primary-dpwh action-btn">
          <i class="bi bi-plus-circle me-2"></i>New Trip Ticket
        </button>
        
        <button onclick="showMyTrips()" class="btn btn-primary action-btn" style="background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%); color: white; border: none;">
          <i class="bi bi-list-check me-2"></i>View My Trips
        </button>
        
        <button onclick="showRequestFuel()" class="btn btn-warning action-btn text-white">
          <i class="bi bi-fuel-pump-fill me-2"></i>Request Fuel
        </button>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav fixed-bottom">
      <div class="container">
        <div class="row">
          <div class="col-3">
            <a href="#" onclick="showHome(); return false;" class="bottom-nav-item active d-block">
              <i class="bi bi-house-fill bottom-nav-icon"></i>
              <small>Home</small>
            </a>
          </div>
          <div class="col-3">
            <a href="#" onclick="showMyTrips(); return false;" class="bottom-nav-item d-block">
              <i class="bi bi-clipboard-check bottom-nav-icon"></i>
              <small>Trips</small>
            </a>
          </div>
          <div class="col-3">
            <a href="#" onclick="showRequestFuel(); return false;" class="bottom-nav-item d-block">
              <i class="bi bi-fuel-pump bottom-nav-icon"></i>
              <small>Fuel</small>
            </a>
          </div>
          <div class="col-3">
            <a href="#" onclick="showProfile(); return false;" class="bottom-nav-item d-block">
              <i class="bi bi-person-fill bottom-nav-icon"></i>
              <small>Profile</small>
            </a>
          </div>
        </div>
      </div>
    </div>
    
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Gmail-Style Modal System -->
  <script src="modal-system.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDTPngeGZviiOjv3N1V_wPTGvRUVFOPa14",
      authDomain: "fuel-vehicle-management.firebaseapp.com",
      projectId: "fuel-vehicle-management",
      storageBucket: "fuel-vehicle-management.firebasestorage.app",
      messagingSenderId: "821758027736",
      appId: "1:821758027736:web:3b1924046e73cb0c9434ad"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // Toggle password visibility
    function togglePassword() {
      const passwordInput = document.getElementById('password');
      const toggleIcon = document.getElementById('password-toggle-icon');

      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.classList.remove('bi-eye');
        toggleIcon.classList.add('bi-eye-slash');
      } else {
        passwordInput.type = 'password';
        toggleIcon.classList.remove('bi-eye-slash');
        toggleIcon.classList.add('bi-eye');
      }
    }

    // Login
    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      if (!email || !password) {
        modalManager.alert({
          title: 'Missing Information',
          message: 'Please enter both email and password.',
          type: 'warning'
        });
        return;
      }

      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        modalManager.alert({
          title: 'Login Failed',
          message: error.message,
          type: 'error'
        });
      }
    }
    
    // Logout
    async function logout() {
      const confirmed = await modalManager.confirm({
        title: 'Confirm Logout',
        message: 'Are you sure you want to logout?',
        confirmText: 'Logout',
        cancelText: 'Cancel',
        confirmType: 'danger'
      });

      if (confirmed) {
        auth.signOut();
      }
    }
    
    // Auto-login check
    auth.onAuthStateChanged(async (user) => {
      // Hide loading splash
      document.getElementById('auth-loading').classList.add('d-none');

      if (user) {
        // User is logged in - show home screen
        document.getElementById('login-screen').classList.add('d-none');
        document.getElementById('home-screen').classList.remove('d-none');
        document.getElementById('user-name').textContent = user.email;
        await loadDashboard();
      } else {
        // User is not logged in - show login screen
        document.getElementById('home-screen').classList.add('d-none');
        document.getElementById('login-screen').classList.remove('d-none');
      }
    });
    
    // Load Dashboard Data
    async function loadDashboard() {
      const user = auth.currentUser;
      
      try {
        // Get trips count
        const tripsSnapshot = await db.collection('dtts')
          .where('driverUid', '==', user.uid)
          .get();
        document.getElementById('trips-count').textContent = tripsSnapshot.size;
        
        // Get fuel requests count
        const fuelSnapshot = await db.collection('risRequests')
          .where('requestedByUid', '==', user.uid)
          .where('status', '==', 'Pending')
          .get();
        document.getElementById('fuel-count').textContent = fuelSnapshot.size;
      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }
    
    // Navigation functions
    function showCreateDtt() {
      window.location.href = 'create-dtt.html';
    }
    
    function showMyTrips() {
      window.location.href = 'my-trips.html';
    }
    
    function showRequestFuel() {
      modalManager.alert({
        title: 'Coming Soon',
        message: 'Request Fuel page is currently under development.',
        type: 'info'
      });
    }
    
    function showHome() {
      location.reload();
    }
    
    function showProfile() {
      modalManager.alert({
        title: 'Coming Soon',
        message: 'Profile page is currently under development.',
        type: 'info'
      });
    }
    
    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed', err));
    }
  </script>

</body>
</html>