<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Request Fuel - DPWH</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

  <!-- Gmail-Style Modal System -->
  <link rel="stylesheet" href="modal-styles.css">

  <!-- Fix for getComputedStyle errors -->
  <script src="fix-getcomputedstyle.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --dpwh-blue: #003f87;
      --dpwh-light-blue: #0056b3;
    }

    body {
      background: linear-gradient(135deg, #fff9c4 0%, #ffeb3b 100%);
      min-height: 100vh;
    }

    .header-dpwh {
      background: linear-gradient(135deg, var(--dpwh-blue) 0%, var(--dpwh-light-blue) 100%);
      color: white;
      padding: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .form-section {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .section-title {
      color: var(--dpwh-blue);
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--dpwh-blue);
    }

    .info-card {
      background: #f8f9fa;
      border-left: 4px solid #ffc107;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .btn-submit {
      background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
      border: none;
      padding: 1rem;
      font-weight: 600;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      color: #000;
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>

  <!-- Loading Splash -->
  <div id="auth-loading" class="container d-flex align-items-center justify-content-center min-vh-100">
    <div class="text-center">
      <div class="spinner-border text-warning mb-3" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-muted">Loading...</p>
    </div>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="d-none">

  <!-- Header -->
  <div class="header-dpwh">
    <div class="container">
      <div class="d-flex align-items-center">
        <button onclick="goBack()" class="btn btn-outline-light btn-sm me-3">
          <i class="bi bi-arrow-left"></i>
        </button>
        <div>
          <h5 class="mb-0"><i class="bi bi-fuel-pump-fill me-2"></i>Request Fuel</h5>
          <small>Standalone Fuel Requisition</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Form -->
  <div class="container py-4" style="padding-bottom: 120px;">

    <!-- Info Alert -->
    <div class="alert alert-warning mb-4">
      <i class="bi bi-info-circle me-2"></i>
      <strong>Standalone Fuel Request:</strong> Use this for additional fuel mid-trip or fuel for non-vehicle purposes (e.g., generator).
    </div>

    <!-- PART 1: Vehicle Selection -->
    <div class="form-section">
      <h6 class="section-title">
        <i class="bi bi-1-circle me-2"></i>VEHICLE INFORMATION
      </h6>

      <div class="mb-3">
        <label class="form-label">Request Type <span class="text-danger">*</span></label>
        <select id="request-type" class="form-select" onchange="toggleRequestType()">
          <option value="">-- Select Type --</option>
          <option value="vehicle">For Vehicle</option>
          <option value="non-vehicle">For Non-Vehicle (Generator, etc.)</option>
        </select>
      </div>

      <!-- Vehicle Section (shows if type = vehicle) -->
      <div id="vehicle-section" class="d-none">
        <div class="mb-3">
          <label class="form-label">Vehicle <span class="text-danger">*</span></label>
          <div class="input-group">
            <input type="text" id="vehicle-search" class="form-control" placeholder="Search vehicle...">
            <button type="button" class="btn btn-primary" onclick="showVehicleSearchModal()">
              <i class="bi bi-search"></i> Search
            </button>
          </div>
          <input type="hidden" id="vehicle" value="">
          <div id="selected-vehicle" class="mt-2 text-muted"></div>
        </div>

        <div class="mb-3">
          <label class="form-label">Plate No.</label>
          <input type="text" id="plateNo" class="form-control" readonly>
        </div>

        <!-- Fuel Balance Info -->
        <div id="fuel-info" class="info-card d-none">
          <div class="d-flex justify-content-between align-items-center">
            <span><i class="bi bi-fuel-pump me-2"></i>Current Fuel Balance:</span>
            <strong id="current-fuel" class="fs-5 text-warning">0 L</strong>
          </div>
        </div>

        <!-- Link to Existing DTT (Optional) -->
        <div class="mb-3">
          <label class="form-label">Link to Existing Trip (Optional)</label>
          <select id="link-dtt" class="form-select">
            <option value="">-- No Linked Trip --</option>
          </select>
          <small class="text-muted">Link this fuel request to an active trip ticket</small>
        </div>
      </div>

      <!-- Non-Vehicle Section (shows if type = non-vehicle) -->
      <div id="non-vehicle-section" class="d-none">
        <div class="mb-3">
          <label class="form-label">Equipment/Purpose <span class="text-danger">*</span></label>
          <input type="text" id="equipment-name" class="form-control text-uppercase"
                 placeholder="E.G., GENERATOR SET, PORTABLE LIGHT">
          <small class="text-muted">Specify what the fuel will be used for</small>
        </div>
      </div>
    </div>

    <!-- PART 2: Fuel Details -->
    <div class="form-section">
      <h6 class="section-title">
        <i class="bi bi-2-circle me-2"></i>FUEL REQUISITION
      </h6>

      <div class="mb-3">
        <label class="form-label">Liters Needed <span class="text-danger">*</span></label>
        <div class="input-group">
          <input type="number" id="fuel-qty" class="form-control"
                 placeholder="50" step="0.1" min="0" onchange="calculateAfterBalance()">
          <span class="input-group-text">liters</span>
        </div>
      </div>

      <!-- Balance After (for vehicles only) -->
      <div id="balance-after-section" class="d-none">
        <div class="alert alert-info">
          <label class="form-label mb-1">Balance After Refuel:</label>
          <div class="fs-4 fw-bold text-primary" id="balance-after">0 L</div>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Purpose <span class="text-danger">*</span></label>
        <textarea id="purpose" rows="3" class="form-control text-uppercase"
                  placeholder="E.G., ADDITIONAL FUEL FOR ONGOING TRIP, FUEL FOR GENERATOR OPERATION"></textarea>
        <small class="text-muted">Explain why this fuel is needed</small>
      </div>

    </div>

    <!-- Action Buttons -->
    <div class="d-grid gap-3" style="margin-bottom: 100px;">
      <button onclick="submitFuelRequest()" class="btn btn-submit text-dark">
        <i class="bi bi-fuel-pump-fill me-2"></i>Submit Fuel Request
      </button>

      <button onclick="goBack()" class="btn btn-outline-secondary">
        <i class="bi bi-x-circle me-2"></i>Cancel
      </button>
    </div>

  </div>

  <!-- Bottom Navigation -->
  <div class="fixed-bottom bg-white border-top shadow-lg">
    <div class="container">
      <div class="row text-center py-2">
        <div class="col-3">
          <a href="index.html" class="d-block text-decoration-none text-secondary">
            <i class="bi bi-house fs-4 d-block"></i>
            <small>Home</small>
          </a>
        </div>
        <div class="col-3">
          <a href="my-trips.html" class="d-block text-decoration-none text-secondary">
            <i class="bi bi-clipboard-check fs-4 d-block"></i>
            <small>Trips</small>
          </a>
        </div>
        <div class="col-3">
          <a href="request-fuel.html" class="d-block text-decoration-none" style="color: var(--dpwh-blue);">
            <i class="bi bi-fuel-pump-fill fs-4 d-block"></i>
            <small class="fw-bold">Fuel</small>
          </a>
        </div>
        <div class="col-3">
          <a href="profile.html" class="d-block text-decoration-none text-secondary">
            <i class="bi bi-person fs-4 d-block"></i>
            <small>Profile</small>
          </a>
        </div>
      </div>
    </div>
  </div>

  </div> <!-- End main-content -->

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Gmail-Style Modal System -->
  <script src="modal-system.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDTPngeGZviiOjv3N1V_wPTGvRUVFOPa14",
      authDomain: "fuel-vehicle-management.firebaseapp.com",
      projectId: "fuel-vehicle-management",
      storageBucket: "fuel-vehicle-management.firebasestorage.app",
      messagingSenderId: "821758027736",
      appId: "1:821758027736:web:3b1924046e73cb0c9434ad"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentFuelBalance = 0;
    let selectedVehicle = null;

    // Check auth
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'index.html';
      } else {
        document.getElementById('auth-loading').classList.add('d-none');
        document.getElementById('main-content').classList.remove('d-none');
        loadVehicles();
        loadActiveDtts();
      }
    });

    // Toggle request type sections
    function toggleRequestType() {
      const type = document.getElementById('request-type').value;
      const vehicleSection = document.getElementById('vehicle-section');
      const nonVehicleSection = document.getElementById('non-vehicle-section');
      const balanceSection = document.getElementById('balance-after-section');

      if (type === 'vehicle') {
        vehicleSection.classList.remove('d-none');
        nonVehicleSection.classList.add('d-none');
      } else if (type === 'non-vehicle') {
        vehicleSection.classList.add('d-none');
        nonVehicleSection.classList.remove('d-none');
        balanceSection.classList.add('d-none');
      } else {
        vehicleSection.classList.add('d-none');
        nonVehicleSection.classList.add('d-none');
        balanceSection.classList.add('d-none');
      }
    }

    // Vehicle cache
    let vehiclesCache = null;

    // Load vehicles into cache
    async function loadVehicles() {
      try {
        if (vehiclesCache) {
          console.log('Using cached vehicles');
          return;
        }

        const snapshot = await db.collection('vehicles').get();

        vehiclesCache = [];
        snapshot.forEach(doc => {
          vehiclesCache.push(doc.data());
        });
        console.log('Loaded', vehiclesCache.length, 'vehicles');
      } catch (error) {
        console.error('Error loading vehicles:', error);
      }
    }

    // Show vehicle search modal
    async function showVehicleSearchModal() {
      // Ensure vehicles are loaded
      await loadVehicles();

      const searchInput = document.getElementById('vehicle-search').value.trim().toUpperCase();

      // Filter vehicles based on search
      let filteredVehicles = vehiclesCache;
      if (searchInput) {
        filteredVehicles = vehiclesCache.filter(v =>
          v.brand.includes(searchInput) ||
          v.model.includes(searchInput) ||
          v.plateNo.includes(searchInput) ||
          (v.dpwhNo && v.dpwhNo.includes(searchInput))
        );
      }

      if (filteredVehicles.length === 0) {
        modalManager.alert({
          title: 'No Vehicles Found',
          message: `No vehicles match "${searchInput}". Try a different search.`,
          type: 'warning'
        });
        return;
      }

      // Build vehicle list HTML
      let vehicleListHtml = '<div class="list-group" style="max-height: 400px; overflow-y: auto;">';
      filteredVehicles.forEach(vehicle => {
        vehicleListHtml += `
          <a href="#" class="list-group-item list-group-item-action" onclick="selectVehicle('${vehicle.plateNo}', '${vehicle.brand}', '${vehicle.model}', ${vehicle.currentFuelBalance || 0}, '${vehicle.dpwhNo || 'N/A'}'); return false;">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">${vehicle.brand} ${vehicle.model}</h6>
              <small>${vehicle.plateNo}</small>
            </div>
            <small class="text-muted">DPWH No: ${vehicle.dpwhNo || 'N/A'} | Fuel: ${(vehicle.currentFuelBalance || 0).toFixed(1)}L</small>
          </a>
        `;
      });
      vehicleListHtml += '</div>';

      modalManager.show({
        title: `Select Vehicle (${filteredVehicles.length} found)`,
        content: vehicleListHtml,
        size: 'medium',
        buttons: [
          { label: 'Cancel', type: 'secondary' }
        ]
      });
    }

    // Select vehicle from modal
    function selectVehicle(plateNo, brand, model, fuelBalance, dpwhNo) {
      // Store selected vehicle
      selectedVehicle = {
        plateNo: plateNo,
        brand: brand,
        model: model,
        currentFuelBalance: fuelBalance,
        dpwhNo: dpwhNo
      };

      document.getElementById('vehicle').value = plateNo;
      document.getElementById('plateNo').value = plateNo;
      document.getElementById('vehicle-search').value = `${brand} ${model} (${plateNo})`;
      document.getElementById('selected-vehicle').innerHTML = `<small><i class="bi bi-check-circle-fill text-success"></i> ${brand} ${model} - ${plateNo} (DPWH: ${dpwhNo})</small>`;

      currentFuelBalance = fuelBalance;
      document.getElementById('current-fuel').textContent = `${fuelBalance.toFixed(1)} L`;
      document.getElementById('fuel-info').classList.remove('d-none');
      document.getElementById('balance-after-section').classList.remove('d-none');

      calculateAfterBalance();

      // Close modal
      modalManager.closeAll();
    }

    // Calculate balance after refuel
    function calculateAfterBalance() {
      const fuelQty = parseFloat(document.getElementById('fuel-qty').value) || 0;
      const afterBalance = currentFuelBalance + fuelQty;
      document.getElementById('balance-after').textContent = `${afterBalance.toFixed(1)} L`;
    }

    // Load active DTTs for linking
    async function loadActiveDtts() {
      try {
        const user = auth.currentUser;
        const snapshot = await db.collection('dtts')
          .where('driverUid', '==', user.uid)
          .where('status', 'in', ['Approved', 'In-Progress'])
          .get();

        const linkSelect = document.getElementById('link-dtt');
        linkSelect.innerHTML = '<option value="">-- No Linked Trip --</option>';

        snapshot.forEach(doc => {
          const dtt = doc.data();
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = `${dtt.dttId} - ${dtt.destination}`;
          linkSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading DTTs:', error);
      }
    }

    // Submit fuel request
    async function submitFuelRequest() {
      const user = auth.currentUser;
      const requestType = document.getElementById('request-type').value;
      const fuelQty = parseFloat(document.getElementById('fuel-qty').value);
      const purpose = document.getElementById('purpose').value.trim();

      // Validation
      if (!requestType) {
        modalManager.alert({
          title: 'Missing Information',
          message: 'Please select request type.',
          type: 'warning'
        });
        return;
      }

      if (requestType === 'vehicle') {
        const vehicle = document.getElementById('vehicle').value;
        if (!vehicle) {
          modalManager.alert({
            title: 'Missing Information',
            message: 'Please select a vehicle.',
            type: 'warning'
          });
          return;
        }
      } else {
        const equipmentName = document.getElementById('equipment-name').value.trim();
        if (!equipmentName) {
          modalManager.alert({
            title: 'Missing Information',
            message: 'Please specify equipment/purpose.',
            type: 'warning'
          });
          return;
        }
      }

      if (!fuelQty || fuelQty <= 0) {
        modalManager.alert({
          title: 'Invalid Input',
          message: 'Please enter a valid fuel quantity.',
          type: 'warning'
        });
        return;
      }

      if (!purpose || purpose.length < 10) {
        modalManager.alert({
          title: 'Invalid Input',
          message: 'Please enter purpose (at least 10 characters).',
          type: 'warning'
        });
        return;
      }

      // Show loading
      const loadingId = modalManager.loading({
        title: 'Submitting Request',
        message: 'Please wait...'
      });

      try {
        const risId = 'RIS_' + Date.now();
        const risData = {
          risId: risId,
          requestType: requestType,

          // Requester
          requestedBy: user.displayName || user.email,
          requestedByUid: user.uid,
          requestedByEmail: user.email,

          // Fuel Details
          requisitionQty: fuelQty,
          issuanceQty: fuelQty, // Initially same as requested
          purpose: purpose,

          // Status
          status: 'Pending',

          // Timestamps
          requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Add vehicle-specific data
        if (requestType === 'vehicle') {
          const linkedDttId = document.getElementById('link-dtt').value;
          risData.plateNo = selectedVehicle.plateNo;
          risData.dpwhNo = selectedVehicle.dpwhNo || 'N/A';
          risData.vehicle = selectedVehicle.brand + ' ' + selectedVehicle.model;
          risData.fuelBalanceBefore = currentFuelBalance;
          risData.linkedDttId = linkedDttId || null;
        } else {
          risData.equipmentName = document.getElementById('equipment-name').value.trim();
          risData.plateNo = null;
          risData.dpwhNo = null;
        }

        // Save to Firestore
        await db.collection('risRequests').doc(risId).set(risData);

        // Update linked DTT if specified
        const linkedDttId = document.getElementById('link-dtt').value;
        if (linkedDttId) {
          await db.collection('dtts').doc(linkedDttId).update({
            linkedRisId: risId,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        // Close loading
        modalManager.close(loadingId);

        // Show success
        await modalManager.alert({
          title: 'Fuel Request Submitted!',
          message: `
            <div class="mb-3">
              <p><strong>RIS ID:</strong> ${risId}</p>
              <p><strong>Quantity:</strong> ${fuelQty} liters</p>
              ${requestType === 'vehicle' ? `<p><strong>Vehicle:</strong> ${selectedVehicle.plateNo}</p>` : ''}
            </div>
            <p class="text-muted mb-0">Your fuel request has been sent to EMD for validation.</p>
          `,
          type: 'success'
        });

        // Redirect to home
        window.location.href = 'index.html';

      } catch (error) {
        console.error('Error submitting fuel request:', error);
        modalManager.close(loadingId);
        modalManager.alert({
          title: 'Error',
          message: 'Failed to submit fuel request: ' + error.message,
          type: 'error'
        });
      }
    }

    // Go back
    function goBack() {
      window.location.href = 'index.html';
    }
  </script>

</body>
</html>
