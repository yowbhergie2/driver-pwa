<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Trip Ticket - DPWH</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

  <!-- Gmail-Style Modal System -->
  <link rel="stylesheet" href="modal-styles.css">

  <!-- Fix for getComputedStyle errors -->
  <script src="fix-getcomputedstyle.js"></script>

  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- DTT PDF Generator -->
  <script src="dtt-pdf-generator.js"></script>

  <style>
    :root {
      --dpwh-blue: #003f87;
      --dpwh-light-blue: #0056b3;
      --dpwh-primary: #4c6ef5;
      --dpwh-primary-dark: #4263eb;
      --dpwh-success: #1e8e3e;
      --dpwh-danger: #d93025;
      --dpwh-warning: #ea8600;
      --border-color: #e8ecef;
      --text-primary: #1a1a2e;
      --text-secondary: #6c757d;
      --bg-light: #f5f7fa;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #fff9c4 0%, #ffeb3b 100%);
      min-height: 100vh;
    }

    /* Modern Header */
    .header-dpwh {
      background: linear-gradient(135deg, var(--dpwh-blue) 0%, var(--dpwh-light-blue) 100%);
      color: white;
      padding: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .header-dpwh .btn-outline-light {
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      padding: 0.5rem 1rem;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .header-dpwh .btn-outline-light:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: white;
      transform: translateY(-2px);
    }

    /* Modern Form Section */
    .form-section {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .section-title {
      color: var(--dpwh-blue);
      font-weight: 600;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--dpwh-blue);
    }

    .info-card {
      background: #f8f9fa;
      border-left: 4px solid #ffc107;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    /* Modern Form Controls */
    .form-label {
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      letter-spacing: 0.3px;
    }

    .form-control,
    .form-select {
      border: 2px solid var(--border-color);
      border-radius: 10px;
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--dpwh-primary);
      box-shadow: 0 0 0 4px rgba(76, 110, 245, 0.1);
    }

    textarea.form-control {
      resize: vertical;
      min-height: 100px;
    }

    .auto-caps {
      text-transform: uppercase;
    }

    /* Modern Input Groups */
    .input-group .btn {
      border-radius: 0 10px 10px 0;
      padding: 0.75rem 1.25rem;
      font-weight: 600;
    }

    .input-group .form-control {
      border-radius: 10px 0 0 10px;
    }

    /* Modern Passenger List */
    .passenger-item {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
    }

    .passenger-item:hover {
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .passenger-item span {
      font-weight: 500;
      color: var(--text-primary);
    }

    .passenger-item .btn-outline-danger {
      border-radius: 8px;
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }

    /* Modern Alert Boxes */
    .alert {
      border-radius: 8px;
      border: none;
      padding: 1rem;
    }

    .alert-info {
      background: #f8f9fa;
      border-left: 4px solid #ffc107;
      color: #000;
    }

    .alert-warning {
      background: #fff3bf;
      color: #e67700;
      border-left: 4px solid var(--dpwh-warning);
    }

    /* Modern Checkbox */
    .form-check-input {
      width: 1.5rem;
      height: 1.5rem;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
    }

    .form-check-input:checked {
      background-color: var(--dpwh-primary);
      border-color: var(--dpwh-primary);
    }

    .form-check-label {
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      margin-left: 0.5rem;
    }

    /* Modern Buttons */
    .btn-submit {
      background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
      border: none;
      padding: 1rem;
      font-weight: 600;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      color: #000;
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }

    .btn-outline-secondary {
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 1rem 2rem;
      font-weight: 600;
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }

    .btn-outline-secondary:hover {
      background: #f8f9fa;
      border-color: var(--text-secondary);
      color: var(--text-primary);
    }

    /* Loading Button State */
    .btn-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Badge Styling */
    .text-danger {
      color: var(--dpwh-danger) !important;
    }

    .text-success {
      color: var(--dpwh-success) !important;
    }

    .text-muted {
      color: var(--text-secondary) !important;
    }

    /* Smooth scrolling for entire page */
    html {
      scroll-behavior: smooth;
    }

    /* Add subtle animation on page load */
    .form-section {
      animation: fadeInUp 0.4s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Form Validation Feedback */
    .form-control.is-valid,
    .form-select.is-valid {
      border-color: var(--dpwh-success);
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%231e8e3e' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right calc(0.375em + 0.5rem) center;
      background-size: calc(0.75em + 1rem) calc(0.75em + 1rem);
      padding-right: calc(1.5em + 1.5rem);
    }

    .form-control.is-invalid,
    .form-select.is-invalid {
      border-color: var(--dpwh-danger);
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23d93025'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23d93025' stroke='none'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right calc(0.375em + 0.5rem) center;
      background-size: calc(0.75em + 1rem) calc(0.75em + 1rem);
      padding-right: calc(1.5em + 1.5rem);
    }

    .invalid-feedback {
      display: none;
      color: var(--dpwh-danger);
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .is-invalid ~ .invalid-feedback {
      display: block;
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
      .form-section {
        padding: 1.25rem;
      }

      .btn-submit,
      .btn-outline-secondary {
        padding: 0.875rem 1.5rem;
      }

      .header-dpwh h5 {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>

  <!-- Loading Splash -->
  <div id="auth-loading" class="container d-flex align-items-center justify-content-center min-vh-100">
    <div class="text-center">
      <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-muted">Loading...</p>
    </div>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="d-none">

  <!-- Header -->
  <div class="header-dpwh">
    <div class="container">
      <div class="d-flex align-items-center">
        <button onclick="goBack()" class="btn btn-outline-light btn-sm me-3">
          <i class="bi bi-arrow-left"></i>
        </button>
        <div>
          <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>New Trip Ticket</h5>
          <small>DPWH Regional Office II</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Form -->
  <!-- [FIX] Changed mb-5 to inline style with 7rem bottom margin to prevent overlap with bottom navigation -->
  <div class="container py-4" style="margin-bottom: 7rem;">
    
    <!-- PART 1: Basic Information -->
    <div class="form-section">
      <h6 class="section-title">
        <i class="bi bi-1-circle me-2"></i>TRIP INFORMATION
      </h6>
      
      <!-- Driver Name -->
      <div class="mb-3">
        <label class="form-label">Driver Name</label>
        <input type="text" id="driverName" class="form-control" readonly>
      </div>

      <!-- Division/Office -->
      <div class="mb-3">
        <label class="form-label">Division/Office <span class="text-danger">*</span></label>
        <select id="division" class="form-select">
          <option value="">-- Select Division/Office --</option>
        </select>
        <div class="invalid-feedback" id="division-error">
          Please select a division/office.
        </div>
      </div>

      <!-- Vehicle & Plate No. -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Vehicle <span class="text-danger">*</span></label>
          <div class="input-group">
            <input type="text" id="vehicle-search" class="form-control" placeholder="Search vehicle...">
            <button type="button" class="btn btn-primary" onclick="showVehicleSearchModal()">
              <i class="bi bi-search"></i> Search
            </button>
          </div>
          <input type="hidden" id="vehicle" value="">
          <div id="selected-vehicle" class="mt-2 text-muted"></div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Plate No. <span class="text-danger">*</span></label>
          <input type="text" id="plateNo" class="form-control auto-caps" readonly>
        </div>
      </div>

      <!-- Fuel Balance Info -->
      <div id="fuel-info" class="info-card d-none">
        <div class="d-flex justify-content-between align-items-center">
          <span><i class="bi bi-fuel-pump me-2"></i>Current Fuel Balance:</span>
          <strong id="current-fuel" class="fs-5 text-warning">0 L</strong>
        </div>
      </div>

      <!-- Authorized Passengers -->
      <div class="mb-3">
        <label class="form-label">
          Name of Authorized Passenger/s
        </label>
        
        <div class="input-group mb-2">
          <input type="text" id="passenger-input" class="form-control auto-caps" 
                 placeholder="ENTER PASSENGER NAME">
          <button onclick="addPassenger()" class="btn btn-primary" type="button">
            <i class="bi bi-plus-lg"></i> Add
          </button>
        </div>
        
        <div id="passengers-list"></div>
      </div>

      <!-- Destination -->
      <div class="mb-3">
        <label class="form-label">Destination <span class="text-danger">*</span></label>
        <input type="text" id="destination" class="form-control auto-caps"
               placeholder="E.G., TUGUEGARAO CITY"
               autocomplete="off"
               list="destination-suggestions">
        <datalist id="destination-suggestions">
          <option value="TUGUEGARAO CITY">
          <option value="MANILA">
          <option value="ISABELA">
          <option value="CAGAYAN">
          <option value="SANTIAGO CITY">
          <option value="ILAGAN CITY">
          <option value="CAUAYAN CITY">
        </datalist>
        <div class="invalid-feedback" id="destination-error">
          Please enter a destination.
        </div>
      </div>

      <!-- Period Covered -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Period Covered - From <span class="text-danger">*</span></label>
          <input type="date" id="periodFrom" class="form-control"
                 onchange="validatePeriodDates()"
                 min="">
          <div class="invalid-feedback" id="periodFrom-error">
            Please select a valid start date.
          </div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Period Covered - To <span class="text-danger">*</span></label>
          <input type="date" id="periodTo" class="form-control"
                 onchange="validatePeriodDates()"
                 min="">
          <div class="invalid-feedback" id="periodTo-error">
            Please select a valid end date.
          </div>
        </div>
      </div>
      <div id="date-error" class="alert alert-danger d-none mb-3"></div>

      <!-- Purpose/s (Multiple) -->
      <div class="mb-3">
        <label class="form-label">Purpose/s <span class="text-danger">*</span></label>
        <textarea id="purposes" rows="4" class="form-control auto-caps"
                  placeholder="ENTER ONE OR MORE PURPOSES (ONE PER LINE)&#10;E.G.:&#10;OFFICIAL TRAVEL TO CONDUCT INSPECTION&#10;ATTEND MEETING WITH REGIONAL DIRECTOR&#10;SITE VISIT TO PROJECT AREA"
                  autocomplete="off"></textarea>
        <small class="text-muted">You can enter multiple purposes, one per line</small>
        <div class="invalid-feedback" id="purpose-error">
          Please enter at least one purpose (minimum 10 characters).
        </div>
      </div>

      <!-- Approving Authority -->
      <div class="mb-3">
        <label class="form-label">Approving Authority <span class="text-danger">*</span></label>
        <select id="approving-authority" class="form-select" onchange="updateAuthorityPrefix()">
          <option value="">-- Select Approving Authority --</option>
        </select>
        <div class="invalid-feedback" id="authority-error">
          Please select an approving authority.
        </div>
      </div>

      <!-- Authority Prefix -->
      <div class="mb-3">
        <label class="form-label">Authority Prefix</label>
        <select id="authority-prefix" class="form-select">
          <option value="">None</option>
          <option value="By Authority of the Regional Director:">By Authority of the Regional Director:</option>
          <option value="By Authority of the OIC-Regional Director:">By Authority of the OIC-Regional Director:</option>
        </select>
        <small class="text-muted">Pre-filled based on selected authority, but can be changed if needed</small>
      </div>
    </div>

    <!-- Request Fuel Section -->
    <div class="form-section">
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="requestFuel" onchange="toggleFuelRequest()">
        <label class="form-check-label fw-bold" for="requestFuel">
          <i class="bi bi-fuel-pump-fill text-warning me-2"></i>
          Request fuel for this trip
        </label>
      </div>

      <div id="fuel-section" class="d-none">
        <div class="info-card">
          <label class="form-label">Liters Needed <span class="text-danger">*</span></label>
          <div class="input-group">
            <input type="number" id="fuel-qty" class="form-control"
                   placeholder="50" step="0.1" min="0">
            <span class="input-group-text">liters</span>
          </div>
          <small class="text-muted">
            Balance after refuel: <strong id="balance-after">0 L</strong>
          </small>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="d-grid gap-3" style="margin-bottom: 100px;">
      <button onclick="submitDtt()" class="btn btn-submit text-dark" id="submit-btn">
        <span id="submit-btn-text">
          <i class="bi bi-check-circle me-2"></i>Submit Trip Ticket
        </span>
        <span id="submit-btn-loading" class="d-none">
          <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          Submitting...
        </span>
      </button>

      <button onclick="goBack()" class="btn btn-outline-secondary">
        <i class="bi bi-x-circle me-2"></i>Cancel
      </button>
    </div>

  </div>

  </div> <!-- End main-content -->

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Gmail-Style Modal System -->
  <script src="modal-system.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDTPngeGZviiOjv3N1V_wPTGvRUVFOPa14",
      authDomain: "fuel-vehicle-management.firebaseapp.com",
      projectId: "fuel-vehicle-management",
      storageBucket: "fuel-vehicle-management.firebasestorage.app",
      messagingSenderId: "821758027736",
      appId: "1:821758027736:web:3b1924046e73cb0c9434ad"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentFuelBalance = 0;
    let passengers = [];
    let divisionsCache = null;

    // Check auth
    auth.onAuthStateChanged(async user => {
      if (!user) {
        // Not logged in - redirect to login
        window.location.href = 'index.html';
      } else {
        // Logged in - show content and load data
        document.getElementById('auth-loading').classList.add('d-none');
        document.getElementById('main-content').classList.remove('d-none');

        // Load driver name
        const userDoc = await db.collection('users').doc(user.uid).get();
        const userName = userDoc.exists && userDoc.data().displayName
          ? userDoc.data().displayName
          : (user.displayName || user.email);
        document.getElementById('driverName').value = userName;

        await loadVehicles();
        await loadDivisions();
        await loadApprovingAuthorities();
      }
    });

    // Initialize form on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Auto-capitalize all inputs with auto-caps class
      const autoCapsInputs = document.querySelectorAll('.auto-caps');
      autoCapsInputs.forEach(input => {
        input.addEventListener('input', function() {
          this.value = this.value.toUpperCase();
        });
      });

      // Set minimum date to today for date inputs
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('periodFrom').setAttribute('min', today);
      document.getElementById('periodTo').setAttribute('min', today);

      // Real-time validation for required fields
      addRealTimeValidation('destination', (value) => value.trim().length > 0);
      addRealTimeValidation('purposes', (value) => {
        const purposes = value.trim().split('\n').filter(p => p.trim().length > 0);
        return purposes.length > 0 && purposes[0].length >= 10;
      });
    });

    // Add real-time validation to form fields
    function addRealTimeValidation(fieldId, validationFn) {
      const field = document.getElementById(fieldId);
      if (!field) return;

      field.addEventListener('blur', function() {
        if (this.value.trim()) {
          if (validationFn(this.value)) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
          } else {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
          }
        }
      });

      field.addEventListener('input', function() {
        if (this.classList.contains('is-invalid') || this.classList.contains('is-valid')) {
          if (validationFn(this.value)) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
          } else {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
          }
        }
      });
    }

    // Vehicle cache
    let vehiclesCache = null;
    let vehiclesCacheTime = null;
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

    // Load divisions into cache
    async function loadDivisions() {
      try {
        if (divisionsCache) {
          console.log('Using cached divisions');
          return;
        }

        const divisionsSnapshot = await db.collection('divisions')
          .where('isActive', '==', true)
          .orderBy('name')
          .get();

        divisionsCache = [];
        const divisionSelect = document.getElementById('division');

        divisionsSnapshot.forEach(doc => {
          const division = doc.data();
          divisionsCache.push(division);

          const option = document.createElement('option');
          option.value = division.name;
          option.textContent = division.name;
          divisionSelect.appendChild(option);
        });

        console.log('Loaded', divisionsCache.length, 'divisions');
      } catch (error) {
        console.error('Error loading divisions:', error);
      }
    }

    // Load approving authorities
    let authoritiesCache = null;
    async function loadApprovingAuthorities() {
      try {
        if (authoritiesCache) {
          console.log('Using cached authorities');
          return;
        }

        const authoritiesSnapshot = await db.collection('approvingAuthorities')
          .where('status', '==', 'active')
          .orderBy('name')
          .get();

        authoritiesCache = [];
        const authoritySelect = document.getElementById('approving-authority');

        authoritiesSnapshot.forEach(doc => {
          const authority = doc.data();
          authoritiesCache.push({
            id: doc.id,
            name: authority.name,
            position: authority.position,
            defaultPrefix: authority.defaultPrefix || ''
          });

          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = authority.name;
          option.dataset.prefix = authority.defaultPrefix || '';
          option.dataset.position = authority.position || '';
          authoritySelect.appendChild(option);
        });

        console.log('Loaded', authoritiesCache.length, 'approving authorities');
      } catch (error) {
        console.error('Error loading approving authorities:', error);
      }
    }

    // Update authority prefix when authority is selected
    function updateAuthorityPrefix() {
      const authoritySelect = document.getElementById('approving-authority');
      const prefixSelect = document.getElementById('authority-prefix');
      const selectedOption = authoritySelect.options[authoritySelect.selectedIndex];

      if (selectedOption && selectedOption.dataset.prefix) {
        prefixSelect.value = selectedOption.dataset.prefix;
      }
    }

    // Load vehicles into cache
    async function loadVehicles() {
      try {
        // Check cache first
        const now = Date.now();
        if (vehiclesCache && vehiclesCacheTime && (now - vehiclesCacheTime < CACHE_DURATION)) {
          console.log('Using cached vehicles');
          return;
        }

        // Load all vehicles for search
        const vehiclesSnapshot = await db.collection('vehicles').get();

        // Cache the results
        vehiclesCache = [];
        vehiclesSnapshot.forEach(doc => {
          vehiclesCache.push(doc.data());
        });
        vehiclesCacheTime = Date.now();
        console.log('Loaded', vehiclesCache.length, 'vehicles');
      } catch (error) {
        console.error('Error loading vehicles:', error);
      }
    }

    // Show vehicle search modal
    async function showVehicleSearchModal() {
      // Ensure vehicles are loaded
      await loadVehicles();

      const searchInput = document.getElementById('vehicle-search').value.trim().toUpperCase();

      // Filter vehicles based on search
      let filteredVehicles = vehiclesCache;
      if (searchInput) {
        filteredVehicles = vehiclesCache.filter(v =>
          v.brand.includes(searchInput) ||
          v.model.includes(searchInput) ||
          v.plateNo.includes(searchInput) ||
          (v.dpwhNo && v.dpwhNo.includes(searchInput))
        );
      }

      if (filteredVehicles.length === 0) {
        modalManager.alert({
          title: 'No Vehicles Found',
          message: `No vehicles match "${searchInput}". Try a different search.`,
          type: 'warning'
        });
        return;
      }

      // Build vehicle list HTML
      let vehicleListHtml = '<div class="list-group" style="max-height: 400px; overflow-y: auto;">';
      filteredVehicles.forEach(vehicle => {
        const dpwhNo = vehicle.dpwhNo || 'N/A';
        const vehicleDetails = `${vehicle.brand} ${vehicle.model} (${vehicle.plateNo})`;
        vehicleListHtml += `
          <a href="#" class="list-group-item list-group-item-action" onclick="selectVehicle('${vehicle.plateNo}', '${vehicle.brand}', '${vehicle.model}', ${vehicle.currentFuelBalance || 0}, '${dpwhNo}'); return false;">
            <div class="d-flex w-100 justify-content-between align-items-center">
              <div>
                <h6 class="mb-1"><strong>${dpwhNo}</strong></h6>
                <small class="text-muted">${vehicleDetails}</small>
              </div>
              <small class="badge bg-info">${(vehicle.currentFuelBalance || 0).toFixed(1)}L</small>
            </div>
          </a>
        `;
      });
      vehicleListHtml += '</div>';

      modalManager.show({
        title: `Select Vehicle (${filteredVehicles.length} found)`,
        content: vehicleListHtml,
        size: 'medium',
        buttons: [
          { label: 'Cancel', type: 'secondary' }
        ]
      });
    }

    // Global variables to store selected vehicle details
    let selectedVehicleData = null;

    // Select vehicle from modal
    function selectVehicle(plateNo, brand, model, fuelBalance, dpwhNo) {
      // Store all vehicle details globally
      selectedVehicleData = {
        plateNo: plateNo,
        brand: brand,
        model: model,
        dpwhNo: dpwhNo,
        fuelBalance: fuelBalance
      };

      document.getElementById('vehicle').value = plateNo;
      document.getElementById('plateNo').value = plateNo;

      // Display DPWH No prominently with details in small text
      document.getElementById('vehicle-search').value = dpwhNo;
      document.getElementById('selected-vehicle').innerHTML = `<small><i class="bi bi-check-circle-fill text-success"></i> ${dpwhNo} - ${brand} ${model} (${plateNo})</small>`;

      currentFuelBalance = fuelBalance;
      document.getElementById('current-fuel').textContent = fuelBalance.toFixed(1) + ' L';
      document.getElementById('fuel-info').classList.remove('d-none');

      // Close modal
      modalManager.closeAll();
    }

    // Generate DTT Number in format DTT-YYYY-MM-#### (resets every year)
    async function generateDttNumber() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');

      // Get all DTTs from current year
      const startOfYear = new Date(year, 0, 1);
      const snapshot = await db.collection('dtts')
        .where('createdAt', '>=', firebase.firestore.Timestamp.fromDate(startOfYear))
        .get();

      // Calculate next number (starts from 1)
      const nextNumber = snapshot.size + 1;
      const numberPart = String(nextNumber).padStart(4, '0');

      return `DTT-${year}-${month}-${numberPart}`;
    }

    // Date validation
    function validatePeriodDates() {
      const periodFrom = document.getElementById('periodFrom').value;
      const periodTo = document.getElementById('periodTo').value;
      const errorDiv = document.getElementById('date-error');

      if (!periodFrom || !periodTo) {
        errorDiv.classList.add('d-none');
        return true;
      }

      const fromDate = new Date(periodFrom);
      const toDate = new Date(periodTo);

      if (fromDate > toDate) {
        errorDiv.textContent = 'Period Covered - From cannot be later than Period Covered - To';
        errorDiv.classList.remove('d-none');
        return false;
      }

      errorDiv.classList.add('d-none');
      return true;
    }

    // Add passenger
    function addPassenger() {
      const input = document.getElementById('passenger-input');
      const name = input.value.trim().toUpperCase();

      if (!name) {
        modalManager.alert({
          title: 'Missing Information',
          message: 'Please enter passenger name.',
          type: 'warning'
        });
        return;
      }

      passengers.push(name);
      input.value = '';
      renderPassengers();
    }

    // Remove passenger
    function removePassenger(index) {
      passengers.splice(index, 1);
      renderPassengers();
    }

    // Render passengers list
    function renderPassengers() {
      const list = document.getElementById('passengers-list');
      if (passengers.length === 0) {
        list.innerHTML = '<small class="text-muted">No passengers added yet</small>';
        return;
      }
      
      list.innerHTML = passengers.map((name, index) => `
        <div class="passenger-item">
          <span>${index + 1}. ${name}</span>
          <button onclick="removePassenger(${index})" class="btn btn-sm btn-outline-danger ms-auto">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      `).join('');
    }

    // Toggle fuel request
    function toggleFuelRequest() {
      const checked = document.getElementById('requestFuel').checked;
      const section = document.getElementById('fuel-section');
      
      if (checked) {
        section.classList.remove('d-none');
      } else {
        section.classList.add('d-none');
      }
    }

    // Calculate fuel balance after refuel
    document.getElementById('fuel-qty').addEventListener('input', function() {
      const fuelNeeded = parseFloat(this.value) || 0;
      const balanceAfter = currentFuelBalance + fuelNeeded;
      document.getElementById('balance-after').textContent = balanceAfter.toFixed(1) + ' L';
    });

    // Generate DTT PDF
    function generateDttPdf(dttData) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // DPWH Header
      doc.setFillColor(0, 63, 135); // DPWH Blue
      doc.rect(0, 0, 210, 25, 'F');

      doc.setTextColor(255, 255, 255);
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text('DPWH REGIONAL OFFICE II', 105, 10, { align: 'center' });
      doc.setFontSize(12);
      doc.text('DRIVER\'S TRIP TICKET', 105, 17, { align: 'center' });

      // Reset text color
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(10);

      let y = 35;

      // DTT ID and Date
      doc.setFont(undefined, 'bold');
      doc.text(`DTT ID: ${dttData.dttId}`, 20, y);
      doc.setFont(undefined, 'normal');
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 150, y);

      y += 10;

      // Trip Information Section
      doc.setFont(undefined, 'bold');
      doc.setFontSize(12);
      doc.text('TRIP INFORMATION', 20, y);
      doc.line(20, y + 2, 190, y + 2);

      y += 10;
      doc.setFontSize(10);

      doc.text('Destination:', 20, y);
      doc.setFont(undefined, 'normal');
      doc.text(dttData.destination, 60, y);
      y += 7;

      doc.setFont(undefined, 'bold');
      doc.text('Purpose:', 20, y);
      doc.setFont(undefined, 'normal');
      const purposeLines = doc.splitTextToSize(dttData.purpose, 130);
      doc.text(purposeLines, 60, y);
      y += (purposeLines.length * 7);

      doc.setFont(undefined, 'bold');
      doc.text('Period Covered:', 20, y);
      doc.setFont(undefined, 'normal');
      doc.text(`${dttData.periodFrom} to ${dttData.periodTo}`, 60, y);
      y += 10;

      // Vehicle Information Section
      doc.setFont(undefined, 'bold');
      doc.setFontSize(12);
      doc.text('VEHICLE INFORMATION', 20, y);
      doc.line(20, y + 2, 190, y + 2);

      y += 10;
      doc.setFontSize(10);

      doc.text('Plate Number:', 20, y);
      doc.setFont(undefined, 'normal');
      doc.text(dttData.plateNo, 60, y);
      y += 7;

      doc.setFont(undefined, 'bold');
      doc.text('Driver:', 20, y);
      doc.setFont(undefined, 'normal');
      doc.text(dttData.driverName, 60, y);
      y += 7;

      if (dttData.passengers && dttData.passengers.length > 0) {
        doc.setFont(undefined, 'bold');
        doc.text('Passengers:', 20, y);
        doc.setFont(undefined, 'normal');
        const passengerText = dttData.passengers.join(', ');
        const passengerLines = doc.splitTextToSize(passengerText, 130);
        doc.text(passengerLines, 60, y);
        y += (passengerLines.length * 7);
      }

      y += 3;

      // Odometer Reading Section
      doc.setFont(undefined, 'bold');
      doc.setFontSize(12);
      doc.text('ODOMETER READING', 20, y);
      doc.line(20, y + 2, 190, y + 2);

      y += 10;
      doc.setFontSize(10);

      doc.text('Start:', 20, y);
      doc.setFont(undefined, 'normal');
      doc.text(`${dttData.speedometerStart || 0} km`, 60, y);
      y += 10;

      // Fuel Information Section
      doc.setFont(undefined, 'bold');
      doc.setFontSize(12);
      doc.text('FUEL INFORMATION', 20, y);
      doc.line(20, y + 2, 190, y + 2);

      y += 10;
      doc.setFontSize(10);

      doc.text('Fuel Balance Start:', 20, y);
      doc.setFont(undefined, 'normal');
      doc.text(`${dttData.fuelBalanceStart || 0} L`, 60, y);
      y += 7;

      if (dttData.requestFuel) {
        doc.setFont(undefined, 'bold');
        doc.setTextColor(234, 134, 0); // Orange
        doc.text('FUEL REQUESTED', 20, y);
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'normal');
        doc.text(`${dttData.requisitionQty} Liters`, 60, y);
        y += 10;
      } else {
        y += 3;
      }

      // Gasoline Details (if provided)
      if (dttData.totalGasoline && dttData.totalGasoline > 0) {
        doc.setFont(undefined, 'bold');
        doc.text('Gasoline Issued:', 20, y);
        y += 7;
        doc.setFont(undefined, 'normal');
        doc.text(`Balance in Tank: ${dttData.balanceInTank || 0} L`, 30, y);
        y += 7;
        doc.text(`Issued by Office: ${dttData.issuedByOffice || 0} L`, 30, y);
        y += 7;
        doc.text(`Purchased During Trip: ${dttData.purchasedDuringTrip || 0} L`, 30, y);
        y += 7;
        doc.setFont(undefined, 'bold');
        doc.text(`Total: ${dttData.totalGasoline} L`, 30, y);
        y += 10;
      }

      // Remarks
      if (dttData.remarks) {
        doc.setFont(undefined, 'bold');
        doc.setFontSize(12);
        doc.text('REMARKS', 20, y);
        doc.line(20, y + 2, 190, y + 2);
        y += 10;
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        const remarkLines = doc.splitTextToSize(dttData.remarks, 170);
        doc.text(remarkLines, 20, y);
        y += (remarkLines.length * 7) + 10;
      } else {
        y += 10;
      }

      // Signature Section
      if (y > 250) {
        doc.addPage();
        y = 20;
      }

      doc.setFontSize(10);
      doc.text('_________________________', 20, y + 20);
      doc.text('Driver\'s Signature', 20, y + 27);
      doc.text('Date: ______________', 20, y + 34);

      doc.text('_________________________', 110, y + 20);
      doc.text('Approved by (Division Chief)', 110, y + 27);
      doc.text('Date: ______________', 110, y + 34);

      // Footer
      doc.setFontSize(8);
      doc.setTextColor(128, 128, 128);
      doc.text('Generated by DPWH Vehicle Management System', 105, 285, { align: 'center' });

      return doc;
    }

    // Submit DTT
    async function submitDtt() {
      // Disable submit button and show loading state
      const submitBtn = document.getElementById('submit-btn');
      const submitBtnText = document.getElementById('submit-btn-text');
      const submitBtnLoading = document.getElementById('submit-btn-loading');

      submitBtn.disabled = true;
      submitBtnText.classList.add('d-none');
      submitBtnLoading.classList.remove('d-none');

      // Get form values
      const division = document.getElementById('division').value.trim();
      const vehicle = document.getElementById('vehicle').value;
      const plateNo = document.getElementById('plateNo').value;
      const destination = document.getElementById('destination').value.trim();
      const periodFrom = document.getElementById('periodFrom').value;
      const periodTo = document.getElementById('periodTo').value;
      const purposesText = document.getElementById('purposes').value.trim();
      const approvingAuthorityId = document.getElementById('approving-authority').value;
      const authorityPrefix = document.getElementById('authority-prefix').value;
      const requestFuel = document.getElementById('requestFuel').checked;
      const fuelQty = requestFuel ? parseFloat(document.getElementById('fuel-qty').value) : 0;

      // Parse purposes (split by newlines and filter empty)
      const purposesArray = purposesText.split('\n').filter(p => p.trim().length > 0);
      const purpose = purposesArray.join('\n'); // Join back for storage

      // Validation with visual feedback
      let hasError = false;

      if (!division) {
        document.getElementById('division').classList.add('is-invalid');
        await modalManager.alert({
          title: 'Missing Information',
          message: 'Please select a division/office.',
          type: 'warning'
        });
        hasError = true;
      } else if (!vehicle) {
        await modalManager.alert({
          title: 'Missing Information',
          message: 'Please select a vehicle.',
          type: 'warning'
        });
        hasError = true;
      } else if (!destination) {
        document.getElementById('destination').classList.add('is-invalid');
        await modalManager.alert({
          title: 'Missing Information',
          message: 'Please enter destination.',
          type: 'warning'
        });
        hasError = true;
      } else if (!periodFrom || !periodTo) {
        if (!periodFrom) document.getElementById('periodFrom').classList.add('is-invalid');
        if (!periodTo) document.getElementById('periodTo').classList.add('is-invalid');
        await modalManager.alert({
          title: 'Missing Information',
          message: 'Please select period covered.',
          type: 'warning'
        });
        hasError = true;
      } else if (!validatePeriodDates()) {
        hasError = true;
      } else if (purposesArray.length === 0 || purposesArray[0].length < 10) {
        document.getElementById('purposes').classList.add('is-invalid');
        await modalManager.alert({
          title: 'Invalid Input',
          message: 'Please enter at least one purpose (minimum 10 characters).',
          type: 'warning'
        });
        hasError = true;
      } else if (!approvingAuthorityId) {
        document.getElementById('approving-authority').classList.add('is-invalid');
        await modalManager.alert({
          title: 'Missing Information',
          message: 'Please select an approving authority.',
          type: 'warning'
        });
        hasError = true;
      } else if (requestFuel && (!fuelQty || fuelQty <= 0)) {
        await modalManager.alert({
          title: 'Missing Information',
          message: 'Please enter fuel quantity needed.',
          type: 'warning'
        });
        hasError = true;
      }

      // Re-enable button if validation fails
      if (hasError) {
        submitBtn.disabled = false;
        submitBtnText.classList.remove('d-none');
        submitBtnLoading.classList.add('d-none');
        return;
      }

      // Show loading modal
      const loadingId = modalManager.loading({
        title: 'Submitting Trip Ticket',
        message: 'Please wait...'
      });

      try {
        const user = auth.currentUser;

        // Generate DTT Number in format DTT-YYYY-MM-#### (resets every year)
        const dttId = await generateDttNumber();

        // Get driver name from field
        const driverName = document.getElementById('driverName').value;

        // Get selected authority details
        const authoritySelect = document.getElementById('approving-authority');
        const selectedAuthority = authoritySelect.options[authoritySelect.selectedIndex];
        const authorityName = selectedAuthority.textContent;
        const authorityPosition = selectedAuthority.dataset.position || '';

        // Prepare DTT data
        const dttData = {
          dttId: dttId,
          driverUid: user.uid,
          driverEmail: user.email,
          driverName: driverName,
          division: division,
          plateNo: plateNo,

          // Vehicle details for display
          vehicleBrand: selectedVehicleData ? selectedVehicleData.brand : '',
          vehicleModel: selectedVehicleData ? selectedVehicleData.model : '',
          vehicleDpwhNo: selectedVehicleData ? selectedVehicleData.dpwhNo : '',

          // Approving Authority
          approvingAuthorityId: approvingAuthorityId,
          approvingAuthorityName: authorityName,
          approvingAuthorityPosition: authorityPosition,
          authorityPrefix: authorityPrefix,

          // Trip Info
          destination: destination,
          periodFrom: periodFrom,
          periodTo: periodTo,
          purpose: purpose,
          purposes: purposesArray, // Store as array
          passengers: passengers,

          // Trip Details - will be filled when closing trip
          timeDepartOffice: null,
          timeArrivalDest: null,
          timeDepartDest: null,
          timeArrivalOffice: null,
          approximateDistance: 0,
          balanceInTank: 0,
          issuedByOffice: 0,
          purchasedDuringTrip: 0,
          totalGasoline: 0,
          gearOil: 0,
          lubOil: 0,
          grease: 0,
          speedometerStart: 0,
          speedometerEnd: 0,
          distanceTravelled: 0,
          remarks: '',

          // Fuel Request
          fuelBalanceStart: currentFuelBalance,
          requestFuel: requestFuel,
          requisitionQty: fuelQty,

          status: 'pending_approval',
          pdfGenerated: true,
          // TODO Phase 2: Add pdfDriveUrl when Cloud Function uploads to Drive
          // Google Drive Folder ID: 1sQbu0kRzgnSqG7areh5WQnVlo_C2YTBM
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Create DTT document
        await db.collection('dtts').doc(dttId).set(dttData);

        // Update loading message
        modalManager.close(loadingId);

        // Generate PDF for download/view
        const pdf = generateDttPdf(dttData);

        // Show success with PDF options
        const successModal = modalManager.show({
          title: 'Trip Ticket Created Successfully!',
          content: `
            <div class="text-center mb-3">
              <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
            </div>

            <div class="modal-info-row">
              <div class="modal-info-label">DTT ID</div>
              <div class="modal-important-info">${dttId}</div>
            </div>

            <div class="modal-info-row">
              <div class="modal-info-label">Destination</div>
              <div class="modal-important-info">${destination}</div>
            </div>

            <div class="alert alert-info mt-3">
              <i class="bi bi-info-circle me-2"></i>
              Download and print this DTT for signatures before your trip.
            </div>
          `,
          size: 'medium',
          closable: false,
          buttons: [
            {
              label: 'Download PDF',
              type: 'primary',
              icon: 'download',
              onClick: () => {
                pdf.save(`DTT_${dttId}.pdf`);
              },
              closeOnClick: false
            },
            {
              label: 'View PDF',
              type: 'secondary',
              icon: 'eye',
              onClick: () => {
                window.open(pdf.output('bloburl'), '_blank');
              },
              closeOnClick: false
            },
            {
              label: 'Done',
              type: 'success',
              onClick: () => {
                // Check if inside iframe (modal)
                if (window.parent !== window) {
                  // Inside iframe - close parent modal
                  window.parent.postMessage({ type: 'CLOSE_MODAL' }, '*');
                } else {
                  // Standalone page - navigate
                  window.location.href = 'index.html';
                }
              }
            }
          ]
        });

      } catch (error) {
        console.error('Error creating DTT:', error);
        modalManager.close(loadingId);
        await modalManager.alert({
          title: 'Error',
          message: 'Failed to create trip ticket: ' + error.message,
          type: 'error'
        });

        // Re-enable submit button on error
        submitBtn.disabled = false;
        submitBtnText.classList.remove('d-none');
        submitBtnLoading.classList.add('d-none');
      }
    }

    // Go back
    async function goBack() {
      const confirmed = await modalManager.confirm({
        title: 'Confirm Cancel',
        message: 'Are you sure you want to cancel? All data will be lost.',
        confirmText: 'Yes, Cancel',
        cancelText: 'No, Stay',
        confirmType: 'danger'
      });

      if (confirmed) {
        // Check if inside iframe (modal)
        if (window.parent !== window) {
          // Inside iframe - close parent modal
          window.parent.postMessage({ type: 'CLOSE_MODAL' }, '*');
        } else {
          // Standalone page - navigate
          window.location.href = 'index.html';
        }
      }
    }

    // Initialize passengers list
    renderPassengers();
  </script>

</body>
</html>